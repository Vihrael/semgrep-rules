rules:
- id: sqlalchemy-distinct-sql-injection
  patterns:
  - pattern-either:
    - pattern: |
        def $FUNC(...,$VAR,...):
          ...
          $SESSION.query(...).distinct("...".format(...,$VAR,...))
    - pattern: |
        def $FUNC(...,$VAR,...):
          ...
          $SESSION.query.join(...).distinct("...".format(...,$VAR,...))
    - pattern: |
        def $FUNC(...,$VAR,...):
          ...
          $SESSION.query.distinct("...".format(...,$VAR,...))
    - pattern: |
        def $FUNC(...,$VAR,...):
          ...
          query.distinct("...".format(...,$VAR,...))
  message: |
    Distinct in SQLAlchemy can cause sql injections if the developer inputs raw SQL into the filter clause. 
    This pattern captures relevant cases in which the developer inputs raw SQL into the distinct parameter and 
    injects user-input into the raw SQL with "format". Instead, use bindParams to securely bind user-input
    to SQL statements.
  fix-regex:
    regex: format
    replacement: bindparams
  languages:
  - python
  severity: WARNING

